<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lumi Draw</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: #f0f2f5;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    background: #1a1a2e;
    color: #fff;
    padding: 14px 20px;
    font-size: 18px;
    font-weight: 600;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  #new-chat-btn {
    font-size: 13px;
    font-weight: 500;
    padding: 6px 14px;
    background: rgba(255,255,255,0.12);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 6px;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.15s;
  }
  #new-chat-btn:hover { background: rgba(255,255,255,0.22); }

  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .msg {
    max-width: 75%;
    padding: 12px 16px;
    border-radius: 12px;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;
  }

  .msg.user {
    align-self: flex-end;
    background: #1a73e8;
    color: #fff;
    border-bottom-right-radius: 4px;
  }

  .msg.bot {
    align-self: flex-start;
    background: #fff;
    color: #333;
    border-bottom-left-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .msg.bot img {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 8px;
    display: block;
  }

  .msg.bot a {
    color: #1a73e8;
    text-decoration: underline;
  }

  .msg.error {
    align-self: flex-start;
    background: #fdecea;
    color: #b71c1c;
    border-bottom-left-radius: 4px;
  }

  .loading {
    align-self: flex-start;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 16px 20px;
    color: #888;
    font-size: 14px;
  }
  .loading .dots {
    display: flex;
    gap: 6px;
  }
  .loading span {
    width: 10px; height: 10px;
    background: #999;
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out both;
  }
  .loading span:nth-child(1) { animation-delay: -0.32s; }
  .loading span:nth-child(2) { animation-delay: -0.16s; }
  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }

  #input-area {
    flex-shrink: 0;
    display: flex;
    gap: 10px;
    padding: 16px 20px;
    background: #fff;
    border-top: 1px solid #e0e0e0;
  }

  #input-area textarea {
    flex: 1;
    padding: 10px 14px;
    font-size: 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    resize: none;
    outline: none;
    font-family: inherit;
    min-height: 44px;
    max-height: 120px;
  }
  #input-area textarea:focus { border-color: #1a73e8; }

  #input-area button {
    padding: 0 20px;
    font-size: 15px;
    background: #1a73e8;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    white-space: nowrap;
  }
  #input-area button:disabled {
    background: #93b8f0;
    cursor: not-allowed;
  }
  #input-area button:hover:not(:disabled) { background: #1565c0; }
</style>
</head>
<body>

<header>
  <span>Lumi Draw</span>
  <button id="new-chat-btn" title="清空当前对话，开始全新会话">＋ 新对话</button>
</header>

<div id="chat"></div>

<div id="input-area">
  <textarea id="msg" rows="1" placeholder="描述你想生成的图片..." autofocus></textarea>
  <button id="send">发送</button>
</div>

<script>
const chat = document.getElementById('chat');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('send');
const newChatBtn = document.getElementById('new-chat-btn');

// ---------------------------------------------------------------------------
// Session state
// ---------------------------------------------------------------------------

let activeConversationId = localStorage.getItem('activeConversationId') || null;

// ---------------------------------------------------------------------------
// New conversation button
// ---------------------------------------------------------------------------

newChatBtn.addEventListener('click', () => {
  activeConversationId = null;
  localStorage.removeItem('activeConversationId');
  chat.innerHTML = '';
  msgInput.focus();
});

// ---------------------------------------------------------------------------
// Lazy conversation creation — called before the first send
// ---------------------------------------------------------------------------

async function ensureConversation() {
  if (activeConversationId) return;
  const resp = await fetch('/api/v1/conversations', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({}),
  });
  if (!resp.ok) throw new Error('Failed to create conversation: ' + resp.status);
  const data = await resp.json();
  activeConversationId = data.conversation_id;
  localStorage.setItem('activeConversationId', activeConversationId);
}

// ---------------------------------------------------------------------------
// Page load: restore history from server if a previous session was saved
// ---------------------------------------------------------------------------

async function restoreHistory() {
  if (!activeConversationId) return;
  try {
    const resp = await fetch(`/api/v1/conversations/${activeConversationId}/messages`);
    if (resp.status === 404) {
      // Session expired on the server; start fresh silently
      activeConversationId = null;
      localStorage.removeItem('activeConversationId');
      return;
    }
    if (!resp.ok) return;
    const data = await resp.json();
    for (const m of data.messages) {
      addMessage(m.content, m.role === 'user' ? 'user' : 'bot');
    }
  } catch (e) {
    console.warn('History restore failed:', e);
  }
}

restoreHistory();

// ---------------------------------------------------------------------------
// Auto-resize textarea
// ---------------------------------------------------------------------------

msgInput.addEventListener('input', () => {
  msgInput.style.height = 'auto';
  msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + 'px';
});

// Send on Enter (Shift+Enter for newline)
msgInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    doSend();
  }
});

sendBtn.addEventListener('click', doSend);

// ---------------------------------------------------------------------------
// UI helpers
// ---------------------------------------------------------------------------

function addMessage(text, cls) {
  const div = document.createElement('div');
  div.className = 'msg ' + cls;
  if (cls === 'bot') {
    div.innerHTML = renderMarkdown(text);
  } else {
    div.textContent = text;
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

let loadingTimer = null;

function showLoading() {
  const div = document.createElement('div');
  div.className = 'loading';
  div.id = 'loading';
  div.innerHTML = '<div class="dots"><span></span><span></span><span></span></div><span class="loading-text">生成中...</span>';
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  const startTime = Date.now();
  loadingTimer = setInterval(() => {
    const el = document.querySelector('#loading .loading-text');
    if (!el) { clearInterval(loadingTimer); return; }
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    if (elapsed < 10) el.textContent = '生成中...';
    else if (elapsed < 30) el.textContent = `生成中... (${elapsed}s)`;
    else el.textContent = `图片生成需要较长时间，请耐心等待... (${elapsed}s)`;
  }, 1000);
}

function hideLoading() {
  if (loadingTimer) { clearInterval(loadingTimer); loadingTimer = null; }
  const el = document.getElementById('loading');
  if (el) el.remove();
}

function rewriteImageUrl(url) {
  // Rewrite http://83.229.124.211:8888/xxx.png to /images/xxx.png (same origin)
  return url.replace(/https?:\/\/83\.229\.124\.211:8888\//g, '/images/');
}

function renderMarkdown(text) {
  text = rewriteImageUrl(text);

  let html = text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  // Images: ![alt](url)
  html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" loading="lazy">');

  // Bare image URLs on their own line (not already in markdown syntax)
  html = html.replace(/(^|\n)(\/images\/[a-f0-9]+\.png)/g, '$1<img src="$2" alt="生成图片" loading="lazy">');

  // Links: [text](url)
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

  // Bold: **text**
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

  // Inline code: `code`
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

  return html;
}

// ---------------------------------------------------------------------------
// Send
// ---------------------------------------------------------------------------

async function doSend() {
  const text = msgInput.value.trim();
  if (!text) return;

  addMessage(text, 'user');
  msgInput.value = '';
  msgInput.style.height = 'auto';
  sendBtn.disabled = true;
  showLoading();

  try {
    await ensureConversation();

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 300000); // 5 min client-side guard

    const resp = await fetch(`/api/v1/conversations/${activeConversationId}/messages`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query: text }),
      signal: controller.signal,
    });
    clearTimeout(timeout);
    hideLoading();

    if (!resp.ok) {
      const contentType = resp.headers.get('content-type') || '';
      let detail = '';
      if (contentType.includes('application/json')) {
        const errData = await resp.json();
        detail = errData.detail || JSON.stringify(errData);
      }

      if (resp.status === 404) {
        // Session expired; clear local ID so next send starts a new session
        activeConversationId = null;
        localStorage.removeItem('activeConversationId');
        addMessage('会话已过期，请重新发送消息以开始新对话。', 'error');
      } else if (resp.status === 409) {
        addMessage('上一条消息仍在处理中，请稍候再试。', 'error');
      } else if (resp.status === 504) {
        addMessage('请求超时：图片生成耗时过长，请尝试简化描述或拆分任务。', 'error');
      } else {
        addMessage('请求失败 ' + resp.status + (detail ? ': ' + detail : ''), 'error');
      }
    } else {
      const data = await resp.json();
      if (data.status === 'success') {
        addMessage(data.result, 'bot');
      } else {
        addMessage(data.error || '生成失败', 'error');
      }
    }
  } catch (e) {
    hideLoading();
    if (e.name === 'AbortError') {
      addMessage('请求超时：图片生成耗时过长，请稍后重试或简化描述。', 'error');
    } else {
      addMessage('网络错误: ' + e.message, 'error');
    }
  } finally {
    sendBtn.disabled = false;
    msgInput.focus();
  }
}
</script>
</body>
</html>
